From 0e268b7b00ef9cbc6170bbdae891c1f4b9d12d47 Mon Sep 17 00:00:00 2001
From: WJXXBSH <zyb_1998@outlook.com>
Date: Wed, 4 Nov 2020 23:01:09 +0800
Subject: [PATCH] Add edge gesture support

Change-Id: Ibbd126196c0c2ab100c3872a7a8b25d31848ffd1
---
 res/values-zh-rCN/strings.xml                 |  2 +
 res/values/strings.xml                        |  2 +
 res/xml/button_settings.xml                   |  4 ++
 .../lineageparts/input/ButtonSettings.java    | 41 +++++++++++++++++++
 4 files changed, 49 insertions(+)

diff --git a/res/values-zh-rCN/strings.xml b/res/values-zh-rCN/strings.xml
index fa31646..7d6dc1d 100644
--- a/res/values-zh-rCN/strings.xml
+++ b/res/values-zh-rCN/strings.xml
@@ -179,6 +179,8 @@
     <string name="home_answer_call_summary">按 Home 键接听来电</string>
     <string name="extras_title">附加功能</string>
     <string name="additional_buttons_title">附加按钮</string>
+    <string name="edge_gesture_title">边缘手势</string>
+    <string name="edge_gesture_summary">双击手机侧边可触发返回操作</string>
     <string name="button_backlight_title">背光</string>
     <string name="button_backlight_enabled">点亮按键</string>
     <string name="button_backlight_only_when_pressed_title">仅在按下时照亮按钮</string>
diff --git a/res/values/strings.xml b/res/values/strings.xml
index c9d78b4..7502da8 100644
--- a/res/values/strings.xml
+++ b/res/values/strings.xml
@@ -213,6 +213,8 @@
     <string name="home_answer_call_summary">Answer incoming calls by pressing the home button</string>
     <string name="extras_title">Extras</string>
     <string name="additional_buttons_title">Additional buttons</string>
+    <string name="edge_gesture_title">Edge gesture</string>
+    <string name="edge_gesture_summary">Double tap to phone\'s edge causes back</string>

     <!-- Key backlight -->
     <string name="button_backlight_title">Backlight</string>
diff --git a/res/xml/button_settings.xml b/res/xml/button_settings.xml
index 37adfed..37c477b 100644
--- a/res/xml/button_settings.xml
+++ b/res/xml/button_settings.xml
@@ -314,6 +314,10 @@
                 android:action="org.lineageos.settings.device.ADDITIONAL_BUTTONS_SETTINGS" />
         </lineageos.preference.RemotePreference>

+        <SwitchPreference
+            android:key="edge_gesture"
+            android:title="@string/edge_gesture_title"
+            android:summary="@string/edge_gesture_summary" />
     </PreferenceCategory>

 </PreferenceScreen>
diff --git a/src/org/lineageos/lineageparts/input/ButtonSettings.java b/src/org/lineageos/lineageparts/input/ButtonSettings.java
index 4b7dc11..268da6c 100644
--- a/src/org/lineageos/lineageparts/input/ButtonSettings.java
+++ b/src/org/lineageos/lineageparts/input/ButtonSettings.java
@@ -53,6 +53,9 @@ import org.lineageos.internal.util.ScreenType;

 import static org.lineageos.internal.util.DeviceKeysConstants.*;

+import java.io.File;
+import java.io.FileReader;
+import java.io.FileWriter;
 import java.util.List;
 import java.util.Set;

@@ -99,6 +102,7 @@ public class ButtonSettings extends SettingsPreferenceFragment
             "torch_long_press_power_gesture";
     private static final String KEY_TORCH_LONG_PRESS_POWER_TIMEOUT =
             "torch_long_press_power_timeout";
+    private static final String KEY_EDGE_GESTURE = "edge_gesture";

     private static final String CATEGORY_POWER = "power_key";
     private static final String CATEGORY_HOME = "home_key";
@@ -137,6 +141,7 @@ public class ButtonSettings extends SettingsPreferenceFragment
     private SwitchPreference mHomeAnswerCall;
     private SwitchPreference mTorchLongPressPowerGesture;
     private ListPreference mTorchLongPressPowerTimeout;
+    private SwitchPreference mEdgeGesture;

     private PreferenceCategory mNavigationPreferencesCat;

@@ -420,6 +425,26 @@ public class ButtonSettings extends SettingsPreferenceFragment
             }
         }

+        // Edge gesture controller
+        int status = 0;
+        File file = new File("/proc/touchscreen/edge_touch_mode");
+        if (file.exists()) {
+            try {
+                FileReader filereader = new FileReader(file);
+                status = filereader.read() - 48; // (ASCII) 0 = 48, 1 = 49
+                filereader.close();
+            } catch (Exception e) {
+                Log.e(TAG, "Error getting edge gesture status");
+            }
+        } else {
+            Log.w(TAG, "File not found: /proc/touchscreen/edge_touch_mode");
+        }
+        mEdgeGesture = prefScreen.findPreference(KEY_EDGE_GESTURE);
+
+        if (mEdgeGesture != null) {
+            mEdgeGesture.setChecked(status > 0);
+        }
+
         // Override key actions on Go devices in order to hide any unsupported features
         if (ActivityManager.isLowRamDeviceStatic()) {
             String[] actionEntriesGo = res.getStringArray(R.array.hardware_keys_action_entries_go);
@@ -735,6 +760,22 @@ public class ButtonSettings extends SettingsPreferenceFragment
         } else if (preference == mHomeAnswerCall) {
             handleToggleHomeButtonAnswersCallPreferenceClick();
             return true;
+        } else if (preference == mEdgeGesture) {
+            int status = mEdgeGesture.isChecked() ? 1 : 0;
+            File file = new File("/proc/touchscreen/edge_touch_mode");
+            if (file.exists()) {
+                try {
+                    FileWriter filewriter = new FileWriter(file);
+                    filewriter.write(String.valueOf(status));
+                    filewriter.flush();
+                    filewriter.close();
+                } catch (Exception e) {
+                    Log.e(TAG, String.format("Error setting edge gesture status to %d", status));
+                }
+            } else {
+                Log.e(TAG, "File not found: /proc/touchscreen/edge_touch_mode");
+            }
+            return true;
         }

         return super.onPreferenceTreeClick(preference);
--
2.27.0
